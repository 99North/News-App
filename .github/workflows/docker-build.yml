name: Versioned Docker Build (Always Build After Version Bump)

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  version-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:

      # 0Ô∏è‚É£ Record Workflow Start Time
      - name: Record workflow start time
        run: echo "GITHUB_WORKFLOW_STARTED_AT=$(date +%s)" >> $GITHUB_ENV

      # 1Ô∏è‚É£ Checkout
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Detect changed folders
      - name: Detect changed folders
        run: |
          git fetch --depth=2
          CHANGED=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED"

          ([[ "$CHANGED" =~ ^frontend/ ]]) && echo "FRONTEND_CHANGED=true" >> $GITHUB_ENV || echo "FRONTEND_CHANGED=false" >> $GITHUB_ENV
          ([[ "$CHANGED" =~ ^backend/ ]]) && echo "BACKEND_CHANGED=true" >> $GITHUB_ENV || echo "BACKEND_CHANGED=false" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Get latest tag
      - name: Get tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v1.0.0")
          echo "LATEST_TAG=$TAG" >> $GITHUB_ENV
          echo "Latest Tag: $TAG"

      # 4Ô∏è‚É£ Extract version
      - name: Extract version
        run: |
          CLEAN=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN"
          echo "MAJOR=$MAJOR" >> $GITHUB_ENV
          echo "MINOR=$MINOR" >> $GITHUB_ENV
          echo "PATCH=$PATCH" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Detect bump
      - name: Detect bump
        run: |
          MSG=$(git log -1 --pretty=%s)
          echo "Commit Message: $MSG"
          
          if echo "$MSG" | grep -q major; then 
            echo "BUMP=major" >> $GITHUB_ENV
          elif echo "$MSG" | grep -q minor; then 
            echo "BUMP=minor" >> $GITHUB_ENV
          elif echo "$MSG" | grep -q patch; then 
            echo "BUMP=patch" >> $GITHUB_ENV
          else 
            echo "BUMP=none" >> $GITHUB_ENV
          fi

          echo "Detected Bump: $BUMP"

      # 6Ô∏è‚É£ Calculate new version
      - name: Calculate new version
        run: |
          if [[ "$BUMP" == "major" ]]; then 
            NEW_VERSION="v$((MAJOR+1)).0.0"
          elif [[ "$BUMP" == "minor" ]]; then 
            NEW_VERSION="v$MAJOR.$((MINOR+1)).0"
          elif [[ "$BUMP" == "patch" ]]; then 
            NEW_VERSION="v$MAJOR.$MINOR.$((PATCH+1))"
          else 
            NEW_VERSION="$LATEST_TAG"
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Create tag if needed
      - name: Push tag
        if: ${{ env.BUMP != 'none' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

      # 8Ô∏è‚É£ Setup Docker
      - name: Setup Docker
        run: echo "Initializing Docker build system..."

      - name: QEMU
        uses: docker/setup-qemu-action@v3

      - name: Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 9Ô∏è‚É£ Build Backend Image
      - name: Build Backend
        if: ${{ env.BACKEND_CHANGED == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAMESPACE }}/backend:${{ env.NEW_VERSION }}
            ${{ env.IMAGE_NAMESPACE }}/backend:latest

      # üîü Build Frontend Image
      - name: Build Frontend
        if: ${{ env.FRONTEND_CHANGED == 'true' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAMESPACE }}/frontend:${{ env.NEW_VERSION }}
            ${{ env.IMAGE_NAMESPACE }}/frontend:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Advanced Final Output Summary
      - name: Final output (Advanced)
        run: |
          echo ""
          echo "=============================="
          echo "  üöÄ BUILD SUMMARY REPORT"
          echo "=============================="
          echo ""
          echo -e "üéØ \033[1;34mCurrent Version:\033[0m    ${LATEST_TAG}"
          echo -e "üéØ \033[1;32mNew Version:\033[0m        ${NEW_VERSION}"
          echo -e "üéØ \033[1;33mBump Type:\033[0m          ${BUMP}"
          echo ""

          if [[ "${BACKEND_CHANGED}" == "true" ]]; then
            echo -e "üõ†Ô∏è  \033[1;32mBackend Built:\033[0m YES"
            echo -e "      ‚Üí Image: $IMAGE_NAMESPACE/backend:${NEW_VERSION}"
            echo -e "      ‚Üí Image: $IMAGE_NAMESPACE/backend:latest"
          else
            echo -e "üõ†Ô∏è  \033[1;31mBackend Built:\033[0m NO (no changes detected)"
          fi
          echo ""

          if [[ "${FRONTEND_CHANGED}" == "true" ]]; then
            echo -e "üõ†Ô∏è  \033[1;32mFrontend Built:\033[0m YES"
            echo -e "      ‚Üí Image: $IMAGE_NAMESPACE/frontend:${NEW_VERSION}"
            echo -e "      ‚Üí Image: $IMAGE_NAMESPACE/frontend:latest"
          else
            echo -e "üõ†Ô∏è  \033[1;31mFrontend Built:\033[0m NO (no changes detected)"
          fi
          echo ""

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - GITHUB_WORKFLOW_STARTED_AT))
          echo -e "‚è±Ô∏è  \033[1;36mTotal Build Time:\033[0m ${DURATION} seconds"
          echo ""
          echo "=============================="
          echo "üéâ BUILD COMPLETED SUCCESSFULLY"
          echo "=============================="
