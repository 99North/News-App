# Versioned Docker Build with ALWAYS-BUILD on Version Bump (Option B)
name: Versioned Docker Build

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  IMAGE_NAMESPACE: ${{ secrets.DOCKERHUB_USERNAME }}

jobs:
  version-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:

      # 0Ô∏è‚É£ Record Workflow Start Time
      - name: Record workflow start time
        run: echo "GITHUB_WORKFLOW_STARTED_AT=$(date +%s)" >> $GITHUB_ENV

      # 1Ô∏è‚É£ Checkout Repository
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2Ô∏è‚É£ Bulletproof Change Detection (no more bad commit errors)
      - name: Detect changed folders
        run: |
          BEFORE=${{ github.event.before }}
          AFTER=${{ github.sha }}

          echo "Before: $BEFORE"
          echo "After:  $AFTER"

          # Check if BEFORE commit exists, otherwise fallback to HEAD~1
          if git cat-file -e "$BEFORE"^{commit} 2>/dev/null; then
            echo "Using BEFORE commit from GitHub event."
            RANGE="$BEFORE $AFTER"
          else
            echo "BEFORE commit does NOT exist. Using fallback HEAD~1."
            RANGE="HEAD~1 HEAD"
          fi

          echo "Diff Range: $RANGE"

          CHANGED=$(git diff --name-only $RANGE)
          echo "$CHANGED"

          [[ "$CHANGED" =~ ^frontend/ ]] && echo "FRONTEND_CHANGED=true" >> $GITHUB_ENV || echo "FRONTEND_CHANGED=false" >> $GITHUB_ENV
          [[ "$CHANGED" =~ ^backend/ ]] && echo "BACKEND_CHANGED=true" >> $GITHUB_ENV || echo "BACKEND_CHANGED=false" >> $GITHUB_ENV

      # 3Ô∏è‚É£ Get latest version tag
      - name: Get tag
        run: |
          TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          echo "LATEST_TAG=$TAG" >> $GITHUB_ENV

      # 4Ô∏è‚É£ Extract major/minor/patch
      - name: Extract version
        run: |
          CLEAN=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$CLEAN"
          echo "MAJOR=$MAJOR" >> $GITHUB_ENV
          echo "MINOR=$MINOR" >> $GITHUB_ENV
          echo "PATCH=$PATCH" >> $GITHUB_ENV

      # 5Ô∏è‚É£ Detect bump type using new commit style: major:, minor:, patch:
      - name: Detect bump
        run: |
          MSG=$(git log -1 --pretty=%s)
          echo "Commit Message: $MSG"

          if echo "$MSG" | grep -iq "^major:"; then 
            echo "BUMP=major" >> $GITHUB_ENV
          elif echo "$MSG" | grep -iq "^minor:"; then 
            echo "BUMP=minor" >> $GITHUB_ENV
          elif echo "$MSG" | grep -iq "^patch:"; then 
            echo "BUMP=patch" >> $GITHUB_ENV
          else 
            echo "BUMP=none" >> $GITHUB_ENV
          fi

      # 6Ô∏è‚É£ Calculate new version
      - name: Calculate new version
        run: |
          if [[ "$BUMP" == "major" ]]; then 
            NEW_VERSION="v$((MAJOR+1)).0.0"
          elif [[ "$BUMP" == "minor" ]]; then 
            NEW_VERSION="v$MAJOR.$((MINOR+1)).0"
          elif [[ "$BUMP" == "patch" ]]; then 
            NEW_VERSION="v$MAJOR.$MINOR.$((PATCH+1))"
          else 
            NEW_VERSION="$LATEST_TAG"
          fi

          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV

      # 7Ô∏è‚É£ Create tag only when bump detected
      - name: Push tag
        if: ${{ env.BUMP != 'none' }}
        run: |
          git config user.name "github-actions"
          git config user.email "actions@github.com"
          git tag -a "$NEW_VERSION" -m "Release $NEW_VERSION"
          git push origin "$NEW_VERSION"

      # 8Ô∏è‚É£ Setup Docker Builder
      - name: Setup Docker
        run: echo "Initializing Docker build..."

      - name: QEMU
        uses: docker/setup-qemu-action@v3

      - name: Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to DockerHub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      # 9Ô∏è‚É£ Build Backend Image (Always build on version bump)
      - name: Build Backend
        if: ${{ env.BUMP != 'none' }}
        uses: docker/build-push-action@v5
        with:
          context: ./backend
          file: ./backend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAMESPACE }}/backend:${{ env.NEW_VERSION }}
            ${{ env.IMAGE_NAMESPACE }}/backend:latest

      # üîü Build Frontend Image (Always build on version bump)
      - name: Build Frontend
        if: ${{ env.BUMP != 'none' }}
        uses: docker/build-push-action@v5
        with:
          context: ./frontend
          file: ./frontend/Dockerfile
          push: true
          platforms: linux/amd64,linux/arm64
          tags: |
            ${{ env.IMAGE_NAMESPACE }}/frontend:${{ env.NEW_VERSION }}
            ${{ env.IMAGE_NAMESPACE }}/frontend:latest

      # 1Ô∏è‚É£1Ô∏è‚É£ Final Beautiful Output
      - name: Final output (Advanced)
        run: |
          echo ""
          echo "=============================="
          echo "  üöÄ BUILD SUMMARY REPORT"
          echo "=============================="
          echo ""
          echo "üéØ Current Version: $LATEST_TAG"
          echo "üéØ New Version:     $NEW_VERSION"
          echo "üéØ Bump Type:       $BUMP"
          echo ""

          if [[ "$BUMP" != "none" ]]; then
            echo "üõ†Ô∏è Backend Built:  YES"
            echo "üõ†Ô∏è Frontend Built: YES"
          else
            echo "üõ†Ô∏è Backend Built:  NO (no bump)"
            echo "üõ†Ô∏è Frontend Built: NO (no bump)"
          fi

          END_TIME=$(date +%s)
          DURATION=$((END_TIME - GITHUB_WORKFLOW_STARTED_AT))
          echo ""
          echo "‚è±Ô∏è Total Build Time: ${DURATION} seconds"
          echo ""
          echo "=============================="
          echo "üéâ BUILD COMPLETED SUCCESSFULLY"
          echo "=============================="
