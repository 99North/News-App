=>Run AkrutiMedia app inside docker steps

=>Go inside frontend/src/context/AuthContenxt.jsx and check this line is exist or not  if not then update it as bellow
const API_BASE_URL =
  (window._env_ && window._env_.REACT_APP_API_URL) ||
  process.env.REACT_APP_API_URL ||
  '/api';

=>Go inside src/services/articleServices.js   and check this line exist or not if not then update it as bellow
const API_BASE_URL =
  (window._env_ && window._env_.REACT_APP_API_URL) ||
  process.env.REACT_APP_API_URL ||
  '/api';


=>Update the .env-prod file inside /frontend folder as this bellow
#REACT_APP_API_URL=65.2.150.166:3001
#use this ip address for internal communication
#REACT_APP_API_URL=/api
REACT_APP_API_URL=https://akrutimedia.com/api


=>Update the .env-prod file inside /backend folder as this bellow
# Database Configuration for development environment, make sure to update these values as per your local setup -RKS
DB_USER=debi
DB_PASSWORD=9090
DB_HOST=postgres-db
DB_PORT=5432
DB_NAME=akrutidev

# Note: JWT Configuration generate it using any online tool or library -RKS
JWT_SECRET=419461bae0350d7058bbb6629f88813c9dfd5498da471466c64caa4e14269c2b27e681f8897c6bf2664fa9bd22408cc0c0937728d13201aff27080dcf8f37d56
JWT_EXPIRES_IN=24h

# Server Port
PORT=3001

#FRONTEND_URL=http://65.2.150.166
FRONTEND_URL=https://akrutimedia.com


=>create a Dockerfile inside /frontend folder and paste this code
# ==========================
# Stage 1: Build React App
# ==========================
FROM node:20-slim AS builder
WORKDIR /app

COPY package*.json ./
RUN npm install

COPY . .

# Build production bundle
RUN npm run build

# ==========================
# Stage 2: Serve with NGINX
# ==========================
FROM nginx:alpine

# Install envsubst
RUN apk add --no-cache gettext

# Copy React build
COPY --from=builder /app/build /usr/share/nginx/html

# Copy env-config.js template
COPY public/env-config.js /usr/share/nginx/html/env-config.js

# Copy nginx config
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 80

# Runtime substitution + start NGINX
CMD ["/bin/sh", "-c", "\
  echo 'Substituting environment variables...'; \
  envsubst < /usr/share/nginx/html/env-config.js > /usr/share/nginx/html/env-config.tmp && \
  mv /usr/share/nginx/html/env-config.tmp /usr/share/nginx/html/env-config.js && \
  nginx -g 'daemon off;'"]



=>run this command inside /frontend folder: docker build -t frontend-app .
=>run this command: docker run -d --name frontend --network akruti-network -p 80:80 frontend-app





=>create a Dockerfile in /backend folder and paste this code
# server/Dockerfile
FROM node:20-slim

WORKDIR /app

COPY package*.json ./
RUN npm ci --only=production

COPY . .


EXPOSE 3001
CMD ["node", "app.js"]

=>run this command inside /backend folder:  docker build -t backend-app .
=>docker run -d  -p 3001:3001 --network akruti-network --env-file .env-prod  --name backend backend-app





=>create a nginx.conf file in /frontend folder & paste this code
server {
    listen 80;
    server_name akrutimedia.com www.akrutimedia.com;

    root /usr/share/nginx/html;
    index index.html;

    # React Router support
    location / {
        try_files $uri /index.html;
    }

    # API proxy
    location /api/ {
        proxy_pass http://backend:3001/;  # <-- backend container name
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection 'upgrade';
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
    }

    # Cache static assets
    location /static/ {
        expires 1y;
        add_header Cache-Control "public, immutable";
    }

    # Error pages fallback
    error_page 404 /index.html;
}


=>create a .env file inside /frontend folder & past the code
REACT_APP_API_URL=/api


=>run:   docker network create akruti-network
=>run:  docker volume create pgdb
=>run this command inside /backend folder
docker run -d   --name postgres-db   --network akruti-network   --env-file ./pg-cred   -v pgdata:/var/lib/postgresql/data   -v "$(pwd)/init.sql:/docker-entrypoint-initdb.d/init.sql"   -p 5432:5432   postgres:16


=>run this inside /backend folder
curl -X POST http://localhost:3001/auth/register   -H "Content-Type: application/json"   -d '{
 "username": "test",
 "email": "test@gmail.com",
 "password": "testpass",
 "firstName": "Test",
 "lastName": "User"
 }'


=>to check what inside the postgres-db container run these commands
docker exec -it postgres-db bash

psql -U debi -d akrutidev

\dt

SELECT * FROM articles;

SELECT * FROM users;


\d articles  or  \d  users   :to check the table structure


=>To take backup of the database run these two commands:   
docker exec postgres-db   
pg_dump -U debi akrutidev > pg_backup.sql


=>To restore the backup into that container or other conatiner
docker exec -i postgres-db 
psql -U debi -d akrutidev < pg_backup.sql



=>To create a crontab for taking auto backup with 7 days roation do these steps:
-create a folder here:   mkdir -p /home/ubuntu/News-App-Backup
-create script & paste the code here & make it executable:  vim News-App-Backup/backup.sh
#!/bin/bash

# ==== CONFIG ====
BACKUP_DIR="/home/ubuntu/News-App-Backup"
CONTAINER_NAME="postgres-db"
DB_USER="debi"
DB_NAME="akrutidev"
RETENTION_DAYS=7
# ================

TIMESTAMP=$(date +"%Y-%m-%d_%H-%M-%S")
BACKUP_FILE="$BACKUP_DIR/backup_$TIMESTAMP.sql"

# Take pg_dump backup
docker exec $CONTAINER_NAME pg_dump -U $DB_USER $DB_NAME > "$BACKUP_FILE"

# Delete old backups (keep recent 7 days)
cd "$BACKUP_DIR"
ls -t | sed -e "1,${RETENTION_DAYS}d" | xargs -r rm --

-create a cronjob and paste it to run it in evryday at 1AM:    crontab -e
0 1 * * * /home/ubuntu/News-App-Backup/backup.sh >/dev/null 2>&1

=>Now to restore the backup run these command one by one
-go inside the pg container:  docker exec -it pg_container bash
-login inside it:  psql -U debi -d akrutidev
-run it to restore the latest backup:   psql -U debi -d akrutidev < /home/ubuntu/News-App-Backup/db_backup_2025-11-30.sql


